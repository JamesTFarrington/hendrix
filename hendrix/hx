#!/bin/bash
# a simple script to help daemonize the process
echoErr () {
    # writes all text to stderr
    echo -e "$@" 1>&2;
}

error () {
    # default error message
    echoErr '\n\r\033[91mERROR: hx could not evaluate. Retry without daemonizing and with --traceback\033[0m'
    exit 1
}

closed () {
    # default exit message
    echoErr '\033[92mHendrix closed successfully\033[0m'
}

hendrix () {
    LOUD="0"
    DAEMONIZE="0"
    for arg in $@; do
        if [[ $arg = "-l" ]] || [[ $arg = "--loud" ]]; then
            LOUD="1"
        fi
        if [[ $arg = "-d" ]] || [[ $arg = "--daemonize" ]]; then
            DAEMONIZE="1"
        fi
    done
    if [[ "$1" = "start" ]] && [[ ! $DAEMONIZE = "1" ]]; then
        echoErr "\033[94mStarting Hendrix...\033[0m"
    fi
    if [[ $LOUD = "1" ]]; then
        python manage.py hx $@
    else
        python -W ignore manage.py hx $@
    fi
    EXIT_CODE=$?
    if [[ "$EXIT_CODE" =  "137" ]]; then  # checks if the the python command was killed
        closed
        EXIT_CODE=0
    fi
    return $EXIT_CODE
}

trap "error" ERR
trap "closed" SIGINT SIGTERM SIGKILL

hendrix $@
